version: '3.9'

services:
  app:
    image: brunocasas/siga-base
    env_file:
      - ./.env
    ports:
      - target: 40143
        published: 40143
    volumes:
      - ./data/props/default.properties:/opt/jboss/siga/default.properties
      - ./data/configs:/opt/jboss/siga/configs
      - ./data/deployments:/opt/jboss/siga/deployments
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=siga_default"
        - "traefik.http.routers.siga.entrypoints=web"
        - "traefik.http.routers.siga.service=siga"
        - "traefik.http.routers.siga.rule=PathPrefix(`/`)"
        - "traefik.http.services.siga.loadbalancer.server.port=8080"
        - "traefik.http.services.siga.loadBalancer.sticky.cookie=true"
        - "traefik.http.services.siga.loadBalancer.sticky.cookie.name=siga-sticky"
        - "traefik.http.routers.admin.entrypoints=admin"
        - "traefik.http.routers.admin.service=admin"
        - "traefik.http.routers.admin.rule=PathPrefix(`/`)"
        - "traefik.http.services.admin.loadbalancer.server.port=9990"
      restart_policy:
        condition: on-failure

  db:
    image: mysql:8.0.25
    command: --default-authentication-plugin=mysql_native_password --log_bin_trust_function_creators=1
    volumes:
      - "./data/mysql:/var/lib/mysql"
    environment:
      MYSQL_ROOT_PASSWORD: SigaAdmin
    ports:
      - "3306"

  phpmyadmin:
    image: phpmyadmin
    environment:
      - PMA_ARBITRARY=1
    links:
      - db

  # nginx:
  #   build: ./services/nginx
  #   networks:
  #     - siga-desenv
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   links:
  #     - app

  viz:
    image: omerio/graphviz-server
    command: "8080"

  bluc:
    image: brunocasas/blucservice
    volumes:
      - ./logs/bluc:/var/log

  assijus:
    image: brunocasas/assijus
    ports:
      - "8484:8080"
    volumes:
      - ./logs/assijus:/var/log
    environment:
      PROP_ASSIJUS_REDIS_MASTER_HOST: redis
      PROP_ASSIJUS_REDIS_MASTER_PORT: 6379
      PROP_ASSIJUS_REDIS_SLAVE_HOST:
      PROP_ASSIJUS_REDIS_SLAVE_PORT:
      PROP_ASSIJUS_REDIS_PASSWORD: sigadesenv
      PROP_ASSIJUS_REDIS_DATABASE: 1
      PROP_ASSIJUS_BLUCSERVICE_URL: http://bluc:8080/blucservice/api/v1
      PROP_ASSIJUS_POPUP_URLS: http://localhost:8080
      PROP_ASSIJUS_SYSTEMS: testsigner
      PROP_ASSIJUS_TESTSIGNER_URL: http://testsigner:8080/testsigner/api/v1
      PROP_ASSIJUS_TESTSIGNER_PASSWORD: sigadesenvteste
      # PROP_ASSIJUS_TIMESTAMP_PUBLIC_KEY:
      # PROP_ASSIJUS_TIMESTAMP_PRIVATE_KEY:

  traefik:
    image: "traefik:v2.5"
    command:
      - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.swarmmode=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.useBindPortIP=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.admin.address=:9990"
      - "--accesslog"
    ports:
      - target: 8080
        published: 8080
        mode: host
      - target: 80
        published: 80
        mode: host
      - target: 9990
        published: 9990
        mode: host
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    depends_on:
      - app:app
    deploy:
      placement:
        constraints:
          - node.role == manager

  redis:
    image: redis
    command: redis-server --requirepass sigadesenv
    ports:
      - "6379:6379"

  # testsigner:
  #   build: ./services/testsigner
  #   networks:
  #     - siga-desenv
  #   ports:
  #     - "5002:8080"
  #   environment:
  #     PROP_TESTSIGNER_PASSWORD: "***GUID***"
